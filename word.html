<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Three.js Dolly + Teclado</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: sans-serif;
    }

    #canvas-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    .controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 10;
    }

    .controls button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    .top-controls {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
    }

    .top-controls button {
      padding: 10px 16px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="canvas-container"></div>

  <!-- Movimiento -->
  <div class="controls">
    <button data-dir="forward">⬆️</button>
    <button data-dir="left">⬅️</button>
    <button data-dir="backward">⬇️</button>
    <button data-dir="right">➡️</button>
  </div>

  <!-- Cambiar modo de cámara -->
  <div class="top-controls">
    <button id="toggleCamera">🎥 Cambiar vista</button>
  </div>

  <!-- Three.js r134 + OrbitControls -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    // Luces
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));
    const light1 = new THREE.DirectionalLight(0xffffff, 0.6);
    light1.position.set(5, 10, 5);
    scene.add(light1);

    const light2 = new THREE.DirectionalLight(0xffffff, 0.3);
    light2.position.set(-5, 10, -5);
    scene.add(light2);

    // Suelo
    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(50, 50),
      new THREE.MeshStandardMaterial({ color: 0x000000 })
    );
    plane.rotation.x = -Math.PI / 2;
    scene.add(plane);

    // Esfera
    const sphere = new THREE.Mesh(
      new THREE.SphereGeometry(1, 32, 32),
      new THREE.MeshStandardMaterial({ color: 0x00ffff })
    );
    sphere.position.y = 1;
    scene.add(sphere);

    // Movimiento
    const directions = { forward: false, backward: false, left: false, right: false };
    const speed = 0.05;

    const buttons = document.querySelectorAll('.controls button');
    buttons.forEach(btn => {
      const dir = btn.getAttribute('data-dir');
      btn.addEventListener('mousedown', () => directions[dir] = true);
      btn.addEventListener('mouseup', () => directions[dir] = false);
      btn.addEventListener('mouseleave', () => directions[dir] = false);
      btn.addEventListener('touchstart', e => {
        e.preventDefault();
        directions[dir] = true;
      }, { passive: false });
      btn.addEventListener('touchend', () => directions[dir] = false);
    });

    // Teclado
    const keyMap = {
      ArrowUp: 'forward',
      ArrowDown: 'backward',
      ArrowLeft: 'left',
      ArrowRight: 'right'
    };

    document.addEventListener('keydown', (e) => {
      const dir = keyMap[e.key];
      if (dir) directions[dir] = true;
    });

    document.addEventListener('keyup', (e) => {
      const dir = keyMap[e.key];
      if (dir) directions[dir] = false;
    });

    // Cámara dinámica
    let isThirdPerson = true;
    const cameraOffset = new THREE.Vector3(0, 5, 10); // Tercera persona

    document.getElementById('toggleCamera').addEventListener('click', () => {
      isThirdPerson = !isThirdPerson;
      controls.enabled = isThirdPerson; // Solo activa OrbitControls en tercera
    });

    // Posición inicial
    camera.position.copy(sphere.position).add(cameraOffset);

    function animate() {
      requestAnimationFrame(animate);

      // Movimiento
      if (directions.forward) sphere.position.z -= speed;
      if (directions.backward) sphere.position.z += speed;
      if (directions.left) sphere.position.x -= speed;
      if (directions.right) sphere.position.x += speed;

      // Cámara
      if (isThirdPerson) {
        const targetPos = new THREE.Vector3().copy(sphere.position).add(cameraOffset);
        camera.position.lerp(targetPos, 0.1);
        camera.lookAt(sphere.position);
      } else {
        const offset = new THREE.Vector3(0, 1.2, 0);
        camera.position.copy(sphere.position).add(offset);
        camera.lookAt(sphere.position.clone().add(new THREE.Vector3(0, 1.2, -1)));
      }

      controls.update();
      renderer.render(scene, camera);
    }

    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
